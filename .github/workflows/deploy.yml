name: Deploy to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  pull_request:
    branches: [ "main" ]

jobs:
  # 1. 외부 fork PR은 GitHub-hosted runner에서만 검증 실행
  external-pr-check:
    if: github.event_name == 'pull_request' &&
        github.event.pull_request.head.repo.full_name != github.repository

    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Validate (Lint/Test optional)
        run: |
          echo "External fork PR detected. Running safe validation on GitHub-hosted runner."

  # 2. 내부 PR / main push / 수동 실행 → self-hosted runner 배포
  deploy:
    if: |
      github.event_name != 'pull_request'
      || github.event.pull_request.head.repo.full_name == github.repository

    runs-on: self-hosted

    steps:
      # 권한 문제 해결을 위한 cleanup
      - name: Clean workspace
        run: |
          cd ${{ github.workspace }} || true
          sudo chown -R ec2-user:ec2-user . || true
          sudo chmod -R 755 . || true

      # 소스 체크아웃
      - name: Checkout source
        uses: actions/checkout@v4

      # 배포 정보 출력
      - name: Show deployment info
        run: |
          echo "Deploying on self-hosted runner (EC2)"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Repo:   ${{ github.repository }}"

      # 체크아웃된 코드를 실제 서비스 디렉토리로 동기화
      - name: Sync code to service directory
        run: |
          # 대상 디렉토리가 없으면 생성
          sudo mkdir -p /home/ec2-user/seoul-airflow
          
          # rsync를 사용하여 동기화 (삭제된 파일도 반영)
          sudo rsync -av --delete \
            --exclude='.git' \
            --exclude='airflow/logs' \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            ${{ github.workspace }}/ /home/ec2-user/seoul-airflow/
          
          # .env 파일을 서비스 디렉토리에 복사
          if [ -f /home/ec2-user/.env ]; then
            sudo cp /home/ec2-user/.env /home/ec2-user/seoul-airflow/.env
            sudo chown ec2-user:ec2-user /home/ec2-user/seoul-airflow/.env
            echo ".env file copied to service directory"
          else
            echo "Warning: .env file not found at /home/ec2-user/.env"
            exit 1
          fi
          
          # 소유권 설정
          sudo chown -R ec2-user:ec2-user /home/ec2-user/seoul-airflow

      # 폴더 권한 정리
      - name: Ensure Directory Permissions for Airflow
        run: |
          cd /home/ec2-user/seoul-airflow
          mkdir -p airflow/logs airflow/dags airflow/plugins || true

          sudo chown -R 50000:992 airflow/logs airflow/dags airflow/plugins || true
          sudo chmod -R 775 airflow/logs airflow/dags airflow/plugins || true

      # Docker compose local build & run
      - name: Local Docker Compose Deploy
        run: |
          cd /home/ec2-user/seoul-airflow
          
          docker compose down || true
          docker compose build
          docker compose up -d

      # Docker 이미지 정리
      - name: Cleanup unused images
        run: docker image prune -af || true
